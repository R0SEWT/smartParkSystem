name: Deploy API Container to Azure Web App

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "api/**"
      - ".github/workflows/api-container-deploy.yml"

env:
  RG: rg-smartpark-brazilsouth
  WEBAPP_NAME: app-smartpark-api
  IMAGE: r0sewt/smartpark:v2
  REGISTRY_URL: https://index.docker.io/v1/
  WEBSITES_PORT: "8080"
  ALLOWED_ORIGINS: https://smartparksysten.azurewebsites.net

jobs:
  deploy-container:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure (publish profile)
        uses: azure/login@v1
        with:
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}

      - name: Configure app settings (registry + CORS + port)
        uses: azure/cli@v1
        with:
          inlineScript: |
            az webapp config appsettings set \
              -g "$RG" -n "$WEBAPP_NAME" --settings \
              DOCKER_REGISTRY_SERVER_URL="${REGISTRY_URL}" \
              DOCKER_REGISTRY_SERVER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}" \
              DOCKER_REGISTRY_SERVER_PASSWORD="${{ secrets.DOCKERHUB_PASSWORD }}" \
              WEBSITES_PORT="${WEBSITES_PORT}" \
              ALLOWED_ORIGINS="${ALLOWED_ORIGINS}"

      - name: Point Web App to container image
        uses: azure/cli@v1
        with:
          inlineScript: |
            az webapp config container set \
              -g "$RG" -n "$WEBAPP_NAME" \
              --docker-custom-image-name "$IMAGE" \
              --docker-registry-server-url "${REGISTRY_URL}" \
              --docker-registry-server-user "${{ secrets.DOCKERHUB_USERNAME }}" \
              --docker-registry-server-password "${{ secrets.DOCKERHUB_PASSWORD }}"

      - name: Restart Web App
        uses: azure/cli@v1
        with:
          inlineScript: |
            az webapp restart -g "$RG" -n "$WEBAPP_NAME"
